generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuthProvider {
  GOOGLE
  APPLE
}

enum EmailProvider {
  GMAIL
  OUTLOOK
}

enum ShopPlatform {
  AMAZON
  ALIEXPRESS
  EBAY
  ETSY
  SHEIN
  TEMU
  WALMART
  SHOPIFY
  UNKNOWN
}

enum PackageStatus {
  ORDERED
  PROCESSING
  SHIPPED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  EXCEPTION
  RETURNED
}

enum Carrier {
  UPS
  FEDEX
  USPS
  DHL
  DPD
  ROYAL_MAIL
  CAINIAO
  YANWEN
  UNKNOWN
}

model User {
  id           String       @id @default(uuid())
  name         String
  email        String       @unique
  avatar       String?
  authProvider  AuthProvider
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  connectedEmails ConnectedEmail[]
  connectedShops  ConnectedShop[]
  orders          Order[]
  notificationPreference NotificationPreference?
  refreshTokens   RefreshToken[]
  auditLogs       AuditLog[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model ConnectedEmail {
  id           String        @id @default(uuid())
  userId       String
  provider     EmailProvider
  email        String
  accessToken  String        // encrypted at rest
  refreshToken String?       // encrypted at rest
  lastSyncAt   DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, email])
  @@index([userId])
  @@map("connected_emails")
}

model ConnectedShop {
  id           String       @id @default(uuid())
  userId       String
  platform     ShopPlatform
  accessToken  String       // encrypted at rest
  refreshToken String?      // encrypted at rest
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@index([userId])
  @@map("connected_shops")
}

model Order {
  id              String       @id @default(uuid())
  userId          String
  shopPlatform    ShopPlatform
  externalOrderId String?
  orderDate       DateTime?
  merchant        String
  totalAmount     Float?
  currency        String?      @db.VarChar(3)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  packages Package[]

  @@index([userId])
  @@index([externalOrderId])
  @@map("orders")
}

model Package {
  id                String        @id @default(uuid())
  orderId           String
  trackingNumber    String
  carrier           Carrier
  status            PackageStatus @default(ORDERED)
  estimatedDelivery DateTime?
  lastLocation      String?
  items             String?       // JSON string of item descriptions
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  order  Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  events TrackingEvent[]

  @@index([orderId])
  @@index([trackingNumber])
  @@index([status])
  @@map("packages")
}

model TrackingEvent {
  id          String        @id @default(uuid())
  packageId   String
  timestamp   DateTime
  location    String?
  status      PackageStatus
  description String
  createdAt   DateTime      @default(now())

  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@index([packageId])
  @@index([timestamp])
  @@map("tracking_events")
}

model NotificationPreference {
  id              String  @id @default(uuid())
  userId          String  @unique
  pushEnabled     Boolean @default(true)
  emailEnabled    Boolean @default(false)
  quietHoursStart String? // e.g. "22:00"
  quietHoursEnd   String? // e.g. "08:00"
  pushToken       String? // FCM/APNs token

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  details   String?
  ipAddress String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}
